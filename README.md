# TCP多客户端聊天系统

这是一个基于C++实现的TCP多客户端聊天系统，支持服务器与多个客户端之间的消息传递、心跳机制和数据结构体传输。

## 主要功能

- **多客户端连接管理**：服务器可以同时处理多个客户端连接
- **心跳机制**：客户端定期向服务器发送心跳包，保持连接活跃
- **消息广播**：服务器可以向所有已连接的客户端广播消息
- **客户端加入通知**：当新客户端连接时，向其他客户端发送通知
- **数据结构体传输**：支持传输包含整数、浮点数和字符串的复杂数据结构
- **日志系统**：服务器端包含完整的日志系统，支持不同日志级别和文件输出
- **命令处理**：客户端支持特殊命令格式发送结构化数据

## 项目结构

```
├── client.cpp      # 客户端实现
├── server.cpp      # 服务器实现
├── message.h       # 消息结构体和常量定义
├── logger.h        # 日志系统实现
└── README.md       # 项目说明文档
```

## 技术实现

### 消息系统

项目使用结构化消息传递机制，主要消息类型包括：
- 普通消息（MSG_TYPE_NORMAL）
- 心跳消息（MSG_TYPE_HEARTBEAT）
- 数据消息（MSG_TYPE_DATA）
- 客户端连接通知（MSG_TYPE_CLIENT_JOIN）

### 数据结构

主要数据结构包括：
- `MessageHeader`：所有消息的通用头部，包含消息类型和长度
- `ClientInfo`：客户端信息，包括ID和名称
- `HeartbeatMessage`：心跳消息，包含客户端信息和时间戳
- `DataMessage`：数据消息，支持多种数据类型

### 多线程实现

- **服务器**：使用三个线程分别处理连接接受、数据接收和消息发送
- **客户端**：使用独立线程定期发送心跳消息

### 日志系统

服务器端实现了完整的日志系统，具有以下特性：
- 支持四种日志级别：DEBUG、INFO、WARNING、ERROR
- 可以同时输出到控制台和日志文件
- 线程安全，使用互斥锁保证多线程环境下的安全写入
- 包含时间戳和日志级别标识

## 编译方法

### Linux/Unix环境

确保系统已安装g++编译器和pthread库，然后执行以下命令：

```bash
# 编译服务器
g++ -std=c++11 -pthread server.cpp -o server

# 编译客户端
g++ -std=c++11 -pthread client.cpp -o client
```

### Windows环境

在Windows环境下，需要使用支持POSIX线程的编译器（如MinGW或Cygwin），或者修改代码使用Windows原生线程API。

## 使用说明

### 启动服务器

```bash
./server
```

服务器将在端口7000上启动，并创建日志文件`server.log`。

### 启动客户端

```bash
./client
```

客户端将自动连接到本地服务器（127.0.0.1:7000），并生成唯一的客户端ID和名称。

### 客户端命令

1. **发送普通消息**：直接输入文本并按回车

2. **发送结构化数据**：使用特殊格式`data:id,value,double_value,string`，例如：
   ```
data:1,100,3.14,Hello World
   ```
   这将发送一个包含ID=1，整数值=100，浮点数值=3.14和字符串="Hello World"的数据结构。

## 项目特点

1. **结构化消息**：使用结构体进行数据传输，比简单的文本传输更加灵活
2. **健壮的连接管理**：处理连接断开、超时等异常情况
3. **线程安全**：服务器使用线程安全的数据结构和互斥锁
4. **可扩展**：模块化设计，易于添加新功能
5. **详细日志**：完善的日志记录有助于调试和问题排查

## 注意事项

- 当前实现使用IPv4地址，端口固定为7000
- 心跳间隔设置为60秒（可在`heartbeatThread`函数中修改）
- 服务器日志文件默认为`server.log`，可以在`main`函数中修改
- 系统没有实现消息加密，仅适用于本地测试或可信网络环境

## 扩展建议

- 添加消息加密功能
- 实现客户端断开通知
- 增加用户名认证机制
- 支持文件传输
- 添加图形用户界面

## 许可证

本项目采用MIT许可证 - 详情请查看LICENSE文件